# NII-DGライブラリによるパッケージング (RO-Crate生成) の実行例

# Overview

- 研究データパッケージングのためのSchema定義としてYAMLファイルとPythonモジュールを記述し、これを用いて、データ型やフィールドのrequired属性など検証を自動的に行う。
- YAMLファイルに記述したSchema定義を元に、閲覧用ドキュメントとしてのMarkdownファイルを生成する。

![nii-dg_lib_overview](https://user-images.githubusercontent.com/31247330/211984174-1ce78018-5e28-4052-92cd-41a0581302ab.png)

## Installation

Python (version>=3.8) を利用する。

```
$ python3 -m pip install .
```

### Docker

Dockerを利用する場合は、例えば以下のように環境を用意する。

```
$ docker run -ti -v $PWD:/app python3-slim bash

# in container
$ cd /app; python3 -m pip install .
```

## Execution example

サンプル実装の実行例を示す。

```
$ python3 tests/example.py
```

`tests/example.py` のパッケージングの実装例では、以下のような RO-Crate が生成される。

```
{
  "@context": "https://w3id.org/ro/crate/1.1/context",
  "@graph": [
    {
      "@id": "./",
      "@type": "Dataset",
      "hasPart": [
        {
          "@id": "file_1.txt"
        }
      ],
      "name": "example research project",
      "dateCreated": "2023-01-20T02:35:21.875+00:00",
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/base/RootDataEntity.json"
    },
    {
      "@id": "ro-crate-metadata.json",
      "@type": "CreativeWork",
      "conformsTo": {
        "@id": "https://w3id.org/ro/crate/1.1"
      },
      "about": {
        "@id": "./"
      }
    },
    {
      "@id": "file_1.txt",
      "@type": "File",
      "name": "Sample File",
      "contentSize": "156GB",
      "dmpDataNumber": {
        "@id": "#dmp:1"
      },
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/cao/File.json"
    },
    {
      "@id": "file_1.txt",
      "@type": "File",
      "name": "Sample File",
      "contentSize": "156GB",
      "experimentPackageFlag": true,
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/ginfork/File.json"
    },
    {
      "@id": "https://www.nii.ac.jp/",
      "@type": "HostingInstitution",
      "name": "National Institute of Informatics",
      "address": "Tokyo Japan",
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/base/HostingInstitution.json"
    },
    {
      "@id": "https://example.com/person",
      "@type": "Person",
      "name": "Ichiro Suzuki",
      "affiliation": {
        "@id": "https://www.nii.ac.jp/"
      },
      "email": "ichiro@example.com",
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/cao/Person.json"
    },
    {
      "@id": "https://example.com/repository",
      "@type": "RepositoryObject",
      "name": "sample repository",
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/base/RepositoryObject.json"
    },
    {
      "@id": "#dmp:1",
      "@type": "DMP",
      "name": "execution results",
      "description": "Files generated by execution of workflow.",
      "creator": [
        {
          "@id": "https://example.com/person"
        }
      ],
      "keyword": "Informatics",
      "accessRights": "metadata only access",
      "repository": {
        "@id": "https://example.com/repository"
      },
      "hostingInstitution": {
        "@id": "https://www.nii.ac.jp/"
      },
      "dataManager": {
        "@id": "https://example.com/person"
      },
      "dataNumber": 1,
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/cao/DMP.json"
    },
    {
      "@id": "#CAO-DMP",
      "@type": "DMPMetadata",
      "name": "CAO-DMP",
      "about": {
        "@id": "./"
      },
      "funder": {
        "@id": "https://www.nii.ac.jp/"
      },
      "keyword": "Informatics",
      "hasPart": [
        {
          "@id": "#dmp:1"
        }
      ],
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/cao/DMPMetadata.json"
    },
    {
      "@id": "#ginmonitoring:1",
      "@type": "GinMonitoring",
      "about": {
        "@id": "./"
      },
      "contentSize": "1TB",
      "workflowIdentifier": "basic",
      "datasetStructure": "with_code",
      "@context": "https://raw.githubusercontent.com/ascade/nii_dg/develop/schema/context/ginfork/GinMonitoring.json"
    }
  ]
}
```

## 仕様に関するメモ: 主な手順

### RootDataEntityの生成

ROCrateインスタンスを生成すると、`root`としてRootDataEntityが生成される。

```python
from nii_dg.ro_crate import ROCrate

ro_crate = ROCrate()
ro_crate.root["name"] = "example research project"
```

### エンティティ生成

生成する対象のエンティティモジュールをimportし、インスタンスを生成する。
プロパティの追加は第二引数(@idが固定のエンティティでは第一引数)の設定でも可能。

```python
from nii_dg.schema.base import HostingInstitution

org = HostingInstitution("https://www.nii.ac.jp/",
                          {"name": "National Institute of Informatics", "address": "Tokyo Japan"})
```

### RO-Crateへエンティティ追加

生成したエンティティは `add()` メソッドによりROCrateインスタンスへの追加を行う。

```python
ro_crate.add(org)
```

### JSON-LDに変換

`as_jsonld()` メソッドは戻り値としてROCrateインスタンスのJSON-LD形式の辞書を返す。

```python
json.dumps(ro_crate.as_jsonld())
```

## 仕様に関するメモ: 注意したいケース
### 同一idに対し複数エンティティを作成する場合
base以外のスキーマを複数利用するとき、1idに対して各スキーマのエンティティ作成をすることが可能。
ただしこのとき、作成する全てのエンティティはbaseから共通のエンティティを継承していることを条件とする。

下記では、`file_1.txt`というファイルについてCaoFile・GinFileの2種のエンティティを作成している。
```python
from nii_dg.schema.cao import File as CaoFile
from nii_dg.schema.ginfork import File as GinFile

file_cao = CaoFile("file_1.txt",
              {"name": "Sample File", "contentSize": "156GB", "dmpDataNumber": dmp_1})
file_gin = GinFile("file_1.txt",
                    {"name": "Sample File", "contentSize": "156GB", "experimentPackageFlag": True})
```

## エンティティ単位での型チェック
エンティティ単位で直接check_props()を呼び出すことも可能。
```python
entity.check_props()
```